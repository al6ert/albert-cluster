# .github/workflows/ci.yaml
name: CI

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # 1) Comprobar si hay charts propios (aún no tienes ninguno, se saltará)
  helm-lint:
    name: Helm lint charts if any exist
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v3
      - name: Helm lint charts
        run: |
          set -e
          found=false
          for d in infra/charts/*; do
            if [ -f "$d/Chart.yaml" ]; then
              echo "🔍 Linting $d"
              helm lint "$d"
              found=true
            fi
          done
          if [ "$found" = false ]; then
            echo "⚠️ No charts under infra/charts/, skipping lint"
          fi

  # 2) Simular despliegue de Traefik contra Netcup
  helm-diff:
    name: Helm Diff Traefik (Netcup preview)
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - uses: actions/checkout@v4

      - name: Set up Helm and Diff plugin
        uses: azure/setup-helm@v3
      - name: Install helm-diff plugin
        run: helm plugin install https://github.com/databus23/helm-diff

      # Configura acceso RO a tu cluster Netcup
      - name: Setup kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.NETCUP_KUBECONFIG_RO }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      # Registra solo el repo de Traefik
      - name: Add Traefik chart repo
        run: |
          helm repo add traefik https://traefik.github.io/charts
          helm repo update

      # Diff para Traefik
      - name: Diff Traefik
        run: |
          helm diff upgrade traefik traefik/traefik \
            --namespace traefik \
            -f infra/envs/netcup/values-traefik.yaml \
            --allow-unreleased
