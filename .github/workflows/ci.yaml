  # 3) Simular despliegue (helm-diff)
  helm-diff:
    name: Helm Diff (Netcup preview)
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Helm
        uses: azure/setup-helm@v3

      - name: Install helm-diff plugin
        run: |
          # Sólo instala si no está ya instalado
          helm plugin list | grep diff || helm plugin install https://github.com/databus23/helm-diff

      - name: Add Helm repos
        run: |
          helm repo add traefik https://traefik.github.io/charts
          helm repo update

      # Diff de Traefik contra el entorno de Netcup
      - name: Diff Traefik
        env:
          HELM_DIFF_USE_UPGRADE_DRY_RUN: "true"
        run: |
          helm diff upgrade traefik traefik/traefik \
            --namespace traefik \
            --allow-unreleased \
            --dry-run client \
            --values infra/apps/traefik/values.yaml \
            --values infra/envs/netcup/traefik-values.yaml
