name: CI

on:
  push:
    branches: [main, dev]
  pull_request:
    branches: [main, dev]
  workflow_dispatch:

jobs:
  validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.14.4

      - name: Install Helmfile
        run: |
          curl -L https://github.com/helmfile/helmfile/releases/download/v0.162.0/helmfile_0.162.0_linux_amd64.tar.gz | tar xz
          sudo mv helmfile /usr/local/bin/

      - name: Render and validate manifests for minikube (dev branch)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "Rendering minikube manifests for dev branch..."
          cd infra/apps
          mkdir -p ../rendered/minikube
          helmfile --environment minikube template > ../rendered/minikube/all.yaml
          
          echo "Validating minikube manifests (client-side only)..."
          kubectl apply --dry-run=client --validate=false -f ../rendered/minikube/all.yaml
          echo "âœ… Minikube manifests are valid"

      - name: Render and validate manifests for netcup (main branch)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Rendering netcup manifests for main branch..."
          cd infra/apps
          mkdir -p ../rendered/netcup
          helmfile --environment netcup template > ../rendered/netcup/all.yaml
          
          echo "Validating netcup manifests (client-side only)..."
          kubectl apply --dry-run=client --validate=false -f ../rendered/netcup/all.yaml
          echo "âœ… Netcup manifests are valid"

      - name: Lint YAML files for minikube (dev branch)
        if: github.ref == 'refs/heads/dev'
        run: |
          echo "Linting YAML files for minikube..."
          python3 -c "import yaml; list(yaml.safe_load_all(open('infra/rendered/minikube/all.yaml'))); print('âœ… Minikube YAML syntax is valid')"
          echo "âœ… YAML linting passed for minikube"

      - name: Lint YAML files for netcup (main branch)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "Linting YAML files for netcup..."
          python3 -c "import yaml; list(yaml.safe_load_all(open('infra/rendered/netcup/all.yaml'))); print('âœ… Netcup YAML syntax is valid')"
          echo "âœ… YAML linting passed for netcup"

  deploy:
    needs: validate
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/dev'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Deploy to ArgoCD
        run: |
          if [ "${{ github.ref }}" = "refs/heads/dev" ]; then
            echo "ðŸš€ Minikube manifests validated and ready for ArgoCD sync"
            echo "ArgoCD will automatically sync from: infra/rendered/minikube/"
          elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "ðŸš€ Netcup manifests validated and ready for ArgoCD sync"
            echo "ArgoCD will automatically sync from: infra/rendered/netcup/"
          fi
          echo ""
          echo "âœ… CI pipeline completed successfully!"
