name: Dev CI

on:
  push:
    branches: [dev]
  pull_request:
    branches: [dev]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: read

jobs:
  validate:
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: 'latest'

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.18.3

      - name: Install curl and Helmfile
        run: |
          apt-get update && apt-get install -y curl
          curl -L https://github.com/helmfile/helmfile/releases/download/v0.162.0/helmfile_0.162.0_linux_amd64.tar.gz | tar xz
          mv helmfile /usr/local/bin/
          chmod +x /usr/local/bin/helmfile

      - name: Render manifests for minikube (dev branch)
        run: |
          echo "Rendering minikube manifests for dev branch..."
          cd infra/apps
          mkdir -p ../rendered/minikube
          helmfile --environment minikube template > ../rendered/minikube/all.yaml
          echo "✅ Minikube manifests rendered successfully"

      - name: Validate YAML syntax for minikube
        run: |
          echo "Validating YAML syntax for minikube..."
          python3 -c "import yaml; list(yaml.safe_load_all(open('infra/rendered/minikube/all.yaml'))); print('✅ Minikube YAML syntax is valid')"
          echo "✅ YAML validation passed for minikube"

      - name: Commit rendered manifests
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add infra/rendered/minikube
          git commit -m "ci: render minikube manifests $(date +%F-%T)" || echo "No changes to commit"
          git push 