name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  # 1) Lint de Helm Charts
  helm-lint:
    name: Helm lint & test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v3

      # Lint de todos tus charts (cuando existan en infra/charts)
      # - name: Helm lint custom charts
      #   run: helm lint infra/charts

      # (Opcional) Instalar y lanzar helm-unittest
      # - name: Install helm-unittest plugin
      #   run: helm plugin install https://github.com/quintush/helm-unittest
      # - name: Run unit tests
      #   run: helm unittest infra/charts/**

  # 2) Build & push de imágenes Docker
  build-and-push:
    name: Build & Push Docker images
    runs-on: ubuntu-latest
    needs: helm-lint
    steps:
      - uses: actions/checkout@v4
      # Login a tu registry (GHCR en este ejemplo)
      - name: Log in to registry
        uses: docker/login-action@v2
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      # Ejemplo de build (descomenta cuando exista la carpeta web)
      # - name: Build & push web image
      #   uses: docker/build-push-action@v4
      #   with:
      #     context: infra/apps/web
      #     push: true
      #     tags: ghcr.io/${{ github.repository_owner }}/web:${{ github.sha }}

  # 3) Diff de Helm contra Netcup (sin clúster)
  helm-diff:
    name: Helm Diff (Netcup preview)
    runs-on: ubuntu-latest
    needs: build-and-push
    steps:
      - uses: actions/checkout@v4
      - name: Set up Helm
        uses: azure/setup-helm@v3
      - name: Install helm-diff plugin
        run: |
          helm plugin install https://github.com/databus23/helm-diff
      - name: Add Helm repos
        run: |
          helm repo add traefik https://traefik.github.io/charts
          helm repo update

      # Diff de Traefik contra los valores de producción Netcup
      - name: Diff Traefik
        run: |
          helm diff upgrade \
            traefik traefik/traefik \
            --namespace traefik \
            --allow-unreleased \
            --values infra/apps/traefik/values.yaml \
            --values infra/envs/netcup/traefik-values.yaml

      # Diff de tu app web (descomentar cuando exista)
      # - name: Diff Web Personal
      #   run: |
      #     helm diff upgrade \
      #       web infra/charts/web \
      #       --namespace web \
      #       --allow-unreleased \
      #       --values infra/envs/netcup/values-web.yaml
